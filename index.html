<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ù…Ø´ØºÙ„ Xtream M3U</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    background: #101820;
    color: white;
  }
  
  .header {
    background: #00b894;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
  }
  
  .logo {
    font-size: 22px;
    font-weight: bold;
    color: white;
  }
  
  .input-area {
    display: flex;
    gap: 10px;
    flex-grow: 1;
    justify-content: flex-end;
  }
  
  .input-area input {
    padding: 10px;
    border-radius: 6px;
    border: none;
    width: 300px;
    max-width: 100%;
  }
  
  .input-area button {
    padding: 10px 20px;
    background-color: #00695c;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }
  
  .input-area button:hover {
    background-color: #004d40;
  }
  
  .main-content {
    max-width: 900px;
    margin: auto;
    padding: 20px;
    text-align: center;
  }
  
  .controls {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 15px;
    margin-bottom: 20px;
  }
  
  select, input[type="text"] {
    padding: 12px;
    border-radius: 8px;
    border: none;
    font-size: 15px;
    width: 100%;
  }
  
  video {
    width: 100%;
    border-radius: 12px;
    box-shadow: 0 0 20px rgba(0,0,0,0.3);
  }
  
  </style>

</head>
<body>
  <header class="header">
    <div class="logo">ğŸ¬ Xtream Player</div>
    <div class="input-area">
      <input type="text" id="m3uUrl" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· M3U">
      <button onclick="loadM3U()">ØªØ­Ù…ÙŠÙ„</button>
    </div>
  </header>

  <main class="main-content">
    <div class="controls">
      <select id="categorySelect" onchange="showChannels()">
        <option value="">Ø§Ø®ØªØ± ÙØ¦Ø©</option>
      </select>

      <input type="text" id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‚Ù†Ø§Ø©" oninput="searchChannels()">

      <select id="channelSelect" onchange="playChannel()">
        <option value="">Ø§Ø®ØªØ± Ù‚Ù†Ø§Ø©</option>
      </select>
    </div>

    <video id="player" controls autoplay></video>
  </main>

  <script>
    let categories = {};
let channels = [];
let currentCategory = [];
let channelQuality = {};  // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø¨Ø¬ÙˆØ¯Ø§Øª Ù…Ø®ØªÙ„ÙØ©

window.onload = () => {
  const lastUrl = localStorage.getItem('lastM3U');
  if (lastUrl) {
    document.getElementById('m3uUrl').value = lastUrl;
  }
};

function loadM3U() {
  const url = document.getElementById('m3uUrl').value.trim();
  if (!url) {
    alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø· M3U.");
    return;
  }

  localStorage.setItem('lastM3U', url);

  fetch(url)
    .then(response => response.text())
    .then(data => parseM3U(data))
    .catch(err => alert("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù: " + err));
}

function parseM3U(data) {
  categories = {};
  channels = [];
  channelQuality = {};  // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© ÙÙŠ ÙƒÙ„ Ù…Ø±Ø©

  const lines = data.split('\n');
  let currentChannel = {};

  for (let i = 0; i < lines.length; i++) {
    if (lines[i].startsWith('#EXTINF')) {
      const nameMatch = lines[i].match(/,(.*)/);
      const groupMatch = lines[i].match(/group-title="(.*?)"/);
      currentChannel = {
        name: nameMatch ? nameMatch[1] : "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ",
        group: groupMatch ? groupMatch[1] : "ØºÙŠØ± Ù…ØµÙ†ÙØ©"
      };
    } else if (lines[i].startsWith('http')) {
      currentChannel.url = lines[i];

      // ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù‚Ù†Ø§Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ¯Ø© (Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¬ÙˆØ¯Ø© ÙÙŠ Ø§Ø³Ù… Ø§Ù„Ù‚Ù†Ø§Ø©)
      const qualityMatch = currentChannel.name.match(/(HD|SD|FHD|4K)/i);
      const quality = qualityMatch ? qualityMatch[1].toUpperCase() : 'SD'; // Ø§ÙØªØ±Ø§Ø¶ SD Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯

      // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù‚Ù†Ø§Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ù‚Ù†ÙˆØ§ØªØŒ Ù†Ø¶ÙŠÙÙ‡Ø§ ÙƒØ¬ÙˆØ¯Ø© Ø¬Ø¯ÙŠØ¯Ø©
      if (!channelQuality[currentChannel.name]) {
        channelQuality[currentChannel.name] = [];
      }
      channelQuality[currentChannel.name].push({ url: currentChannel.url, quality: quality });

      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ù†Ø§Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
      if (!categories[currentChannel.group]) {
        categories[currentChannel.group] = [];
      }
      categories[currentChannel.group].push({...currentChannel});
      channels.push({...currentChannel});
    }
  }

  fillCategories();
}

function fillCategories() {
  const select = document.getElementById('categorySelect');
  select.innerHTML = '<option value="">Ø§Ø®ØªØ± ÙØ¦Ø©</option>';

  Object.keys(categories).forEach(cat => {
    const option = document.createElement('option');
    option.value = cat;
    option.textContent = cat;
    select.appendChild(option);
  });

  document.getElementById('channelSelect').innerHTML = '<option value="">Ø§Ø®ØªØ± Ù‚Ù†Ø§Ø©</option>';
}

function showChannels() {
  const cat = document.getElementById('categorySelect').value;
  const select = document.getElementById('channelSelect');
  select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù‚Ù†Ø§Ø©</option>';

  currentCategory = cat && categories[cat] ? categories[cat] : [];

  currentCategory.forEach(ch => {
    const option = document.createElement('option');
    option.value = ch.name;  // Ø­ÙØ¸ Ø§Ø³Ù… Ø§Ù„Ù‚Ù†Ø§Ø©
    option.textContent = ch.name;
    select.appendChild(option);
  });

  document.getElementById('searchInput').value = "";
}

function searchChannels() {
  const keyword = document.getElementById('searchInput').value.toLowerCase();
  const select = document.getElementById('channelSelect');
  select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù‚Ù†Ø§Ø©</option>';

  currentCategory
    .filter(ch => ch.name.toLowerCase().includes(keyword))
    .forEach(ch => {
      const option = document.createElement('option');
      option.value = ch.name;  // Ø­ÙØ¸ Ø§Ø³Ù… Ø§Ù„Ù‚Ù†Ø§Ø©
      option.textContent = ch.name;
      select.appendChild(option);
    });
}

function playChannel() {
  const channelName = document.getElementById('channelSelect').value;
  const video = document.getElementById('player');

  if (!channelName) return;

  // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ù‚Ù†ÙˆØ§Øª Ø¨Ø¬ÙˆØ¯Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø©
  const availableQualities = channelQuality[channelName];
  if (availableQualities && availableQualities.length > 1) {
    const qualitySelect = document.createElement('select');
    qualitySelect.id = 'qualitySelect';
    availableQualities.forEach(quality => {
      const option = document.createElement('option');
      option.value = quality.url;
      option.textContent = quality.quality;
      qualitySelect.appendChild(option);
    });

    // Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¬ÙˆØ¯Ø©
    const qualityDiv = document.createElement('div');
    qualityDiv.textContent = 'Ø§Ø®ØªØ± Ø§Ù„Ø¬ÙˆØ¯Ø©: ';
    qualityDiv.appendChild(qualitySelect);
    document.querySelector('.controls').appendChild(qualityDiv);

    // Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø¬ÙˆØ¯Ø©ØŒ Ù‚Ù… Ø¨ØªØ´ØºÙŠÙ„ Ø§Ù„Ù‚Ù†Ø§Ø© Ø¨Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
    qualitySelect.addEventListener('change', function () {
      const selectedUrl = qualitySelect.value;
      playSelectedQuality(selectedUrl);
    });

    // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰
    playSelectedQuality(availableQualities[0].url);
  } else {
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø±Ø§Ø¨Ø· ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· Ù„Ù„Ø¬ÙˆØ¯Ø©ØŒ Ù†Ù‚ÙˆÙ… Ø¨ØªØ´ØºÙŠÙ„Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø©
    playSelectedQuality(availableQualities[0].url);
  }
}

function playSelectedQuality(url) {
  const video = document.getElementById('player');

  // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø´ØºÙ„ Ø§Ù„Ø³Ø§Ø¨Ù‚
  if (window.hls) {
    window.hls.destroy();
    window.hls = null;
  }

  const isHLS = url.endsWith(".m3u8") || url.endsWith(".ts") || url.includes("/live/");

  if (isHLS && Hls.isSupported()) {
    window.hls = new Hls();
    window.hls.loadSource(url);
    window.hls.attachMedia(video);

    window.hls.on(Hls.Events.ERROR, function (event, data) {
      console.error("HLS error:", data);
      alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù‚Ù†Ø§Ø©.");
    });
  } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
    video.src = url;
    video.play();
  } else {
    video.src = url;
    video.play();
  }
}
  </script>
</body>
</html>
